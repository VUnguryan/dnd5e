<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="layouts/default">
<head>
<title>DnD 5E Монстры</title>
<meta charset="utf-8">

<link rel="icon" th:href="@{/resources/icon.png}">
<link rel="icon" th:href="@{/resources/icon.png}">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!-- Bootstrap CSS -->
<link rel="stylesheet"
	th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}" />
<link rel="stylesheet"
	th:href="@{/resources/css/bootstrap-multiselect.css}" />
<link rel="stylesheet" th:href="@{/resources/css/main.css}" />
</head>
<body>
	<div th:insert="fragments/header :: header(~{ :: .creatures})"></div>
	<div class="container" style="margin-top: 25px">
		<div th:replace="fragments/header :: saf"></div>
		<div id=filter class="collapse" th:classappend="${filtered} ? show">
			<div class="card">
				<div class="card-body">
					<div class="input-group mb-4">
						<div class="input-group-prepend">
							<label class="input-group-text" for="minLevel">Опасность:
							</label>
						</div>
						<select id="crMin" class="custom-select" onchange="filter()">
							<option value="-1">---</option>
							<option value="1/8"
								th:selected="${crMin.present && #strings.equals('1/8', crMin.get())}">1/8</option>
							<option value="1/4"
								th:selected="${crMin.present && #strings.equals('1/4', crMin.get())}">1/4</option>
							<option value="1/2"
								th:selected="${crMin.present && #strings.equals('1/2', crMin.get())}">1/2</option>
							<option th:each="i: ${#numbers.sequence(1,30)}" th:text="${i}"
								th:value="${i}"
								th:selected="${crMin.present && #strings.equals(#strings.toString(i), crMin.get())}" />
						</select>
						<div class="input-group-prepend">
							<label class="input-group-text" for="maxLevel">до</label>
						</div>
						<select id="crMax" class="custom-select" onchange="filter()">
							<option value="-1">---</option>
							<option value="1/8"
								th:selected="${crMax.present && #strings.equals('1/8', crMax.get())}">1/8</option>
							<option value="1/4"
								th:selected="${crMax.present && #strings.equals('1/4', crMax.get())}">1/4</option>
							<option value="1/2"
								th:selected="${crMax.present && #strings.equals('1/2', crMax.get())}">1/2</option>
							<option th:each="i: ${#numbers.sequence(1, 30)}" th:text="${i}"
								th:value="${i}"
								th:selected="${crMax.present && #strings.equals(#strings.toString(i), crMax.get())}" />
						</select>
					</div>
					<div class="input-group mb-4">
						<div class="input-group-prepend">
							<label class="input-group-text" for="schoolType">Тип</label>
						</div>
						<select id="creatureType" class="custom-select"
							onchange="filter()">
							<option value="ALL">все</option>
							<option th:each="type : ${types}" th:value="${type}"
								th:text="${type.cyrilicName}"
								th:selected="${typeSelected.present && type==typeSelected.get()}" />
						</select>
					</div>
					<div class="input-group mb-4">
						<div class="input-group-prepend">
							<label class="input-group-text" for="ctreatureSize">Размер</label>
						</div>
						<select id="creatureSize" class="custom-select"
							onchange="filter()">
							<option value="ALL">все</option>
							<option th:each="size : ${sizes}" th:value="${size}"
								th:text="${size.cyrilicName}"
								th:selected="${sizeSelected.present && size==sizeSelected.get()}" />
						</select>
					</div>
					<div class="input-group mb-4">
						<div class="input-group-prepend">
							<label class="input-group-text" for="ctreatureSize">Уязвимость
								к урону</label>
						</div>
						<select id="vulnerability" class="custom-select"
							onchange="filter(this.value, 'vulnerability')">
							<option value="ALL">---</option>
							<option th:each="vulnerability : ${vulnerabilities}"
								th:value="${vulnerability}"
								th:text="${vulnerability.cyrilicName}"
								th:selected="${vulnerability eq vulnerabilitySelected}" />
						</select>
						<div class="input-group-prepend">
							<label class="input-group-text" for="ctreatureSize">Сопротивление
								к урону</label>
						</div>
						<select id="resistance" class="custom-select"
							onchange="filter(this.value, 'resistance')">
							<option value="ALL">---</option>
							<option th:each="resist : ${resistance}" th:value="${resist}"
								th:text="${resist.cyrilicName}"
								th:selected="${resist eq resistanceSelected}" />
						</select>
						<div class="input-group-prepend">
							<label class="input-group-text" for="ctreatureSize">Иммунитет
								к урону</label>
						</div>
						<select id="immunity" class="custom-select"
							onchange="filter(this.value, 'immunity')">
							<option value="ALL">---</option>
							<option th:each="immunity : ${immunities}" th:value="${immunity}"
								th:text="${immunity.cyrilicName}"
								th:selected="${immunity eq immunitySelected}" />
						</select>
						<div class="input-group-prepend">
							<label class="input-group-text" for="ctreatureSize">Иммунитет
								к состоянию</label>
						</div>
						<select id="stateImmunity" class="custom-select"
							onchange="filter(this.value, 'stateImmunity')">
							<option value="ALL">---</option>
							<option th:each="stateImmunity : ${stateImmunities}"
								th:value="${stateImmunity}"
								th:text="${stateImmunity.cyrilicName}"
								th:selected="${stateImmunity eq stateImmunitySelected}" />
						</select>
					</div>
					<div class="input-group mb-4">
						<div class="input-group-prepend">
							<label class="input-group-text" for="actions">Действия</label>
						</div>
						<select id="actions" class="custom-select"
							onchange="filter(this.value, 'action')">
							<option value="ALL">---</option>
							<option th:each="actionType : ${actionTypes}"
								th:value="${actionType}"
								th:text="${actionType.name}"
								th:selected="${actionType eq actionTypeSelected}" />
						</select>
						<div class="input-group-prepend">
							<label class="input-group-text" for="сaster">Заклинатель</label>
						</div>
						<select id="сaster" class="custom-select"
							onchange="filter(this.value, 'caster')">
							<option value="ALL">---</option>
							<option value="innateWitchcraft" th:selected="${casterSelected} eq 'Врожденное Колдовство'">Врожденное Колдовство</option>
							<option value="useOfSpells" th:selected="${casterSelected} eq 'Использование заклинаний'">Использование заклинаний</option>
							<option value="witchcraft" th:selected="${casterSelected} eq 'Колдовство'">Колдовство</option>
						</select>
					</div>
					<div class="input-group mb-4">
						<div class="input-group-prepend">
							<label class="input-group-text" for="ctreatureSize">Обитание</label>
						</div>
						<select id="habitatType" class="custom-select" multiple="multiple">
							<option th:each="habitat : ${habitats}" th:value="${habitat}"
								th:text="${habitat.name}"
								th:selected="${habitatsSelected.contains(habitat)}" />
						</select>
					</div>
					<div class="input-group mb-4">
						<div class="input-group-prepend">
							<label class="input-group-text" for="source">Источник</label>
						</div>
						<select id="sourceBook" class="custom-select" multiple="multiple">
							<option th:each="book : ${books}" th:value="${book.source}"
								th:text="${book.name  + ' (' + book.type.name +')'}"
								th:selected="${selectedBooks.contains(book.source)}" />
						</select>
					</div>
					<a th:if="${filtered}" th:href="@{/creatures/?clear}" role="button"
						class="btn btn-danger"><img
						th:src="@{/resources/open-iconic/svg/x.svg}"></img> &nbsp;
						Сбросить фильтры</a>
				</div>
			</div>
		</div>
		<table class="table table-striped">
			<thead>
				<tr style="cursor: pointer">
					<th onclick="sortTable(0)" scope="col" style="width: 3%">CR <img
						th:if="${param.sort != null AND param.sort[0] == 'exp,asc'}"
						th:src="@{/resources/open-iconic/svg/caret-bottom.svg}"> <img
						th:if="${param.sort != null AND param.sort[0] == 'exp,desc'}"
						th:src="@{/resources/open-iconic/svg/caret-top.svg}">
					</th>
					<th onclick="sortTable(1)" scope="col">Наименование <img
						th:if="${param.sort != null AND param.sort[0] == 'name,asc'}"
						th:src="@{/resources/open-iconic/svg/caret-bottom.svg}"> <img
						th:if="${param.sort != null AND param.sort[0] == 'name,desc'}"
						th:src="@{/resources/open-iconic/svg/caret-top.svg}">
					</th>
					<th onclick="sortTable(2)" scope="col" style="width: 20%">Вид
						<img th:if="${param.sort != null AND param.sort[0] == 'type,asc'}"
						th:src="@{/resources/open-iconic/svg/caret-bottom.svg}"> <img
						th:if="${param.sort != null AND param.sort[0] == 'type,desc'}"
						th:src="@{/resources/open-iconic/svg/caret-top.svg}">
					</th>
					<th style="width: 1%"th:if="${session.settings != null and session.settings.homeRule}"></th>
				</tr>
			</thead>
			<tr th:each="creature : ${creatures}" style="cursor: pointer"
				th:onclick="'javascript:rowClicked(\'' + ${creature.id} + '\');'">
				<td th:text="${creature.challengeRating}" />
				<td th:text="${creature.name}" />
				<td th:text="${creature.type.cyrilicName}" />
				<td><img th:if="${session.settings != null and session.settings.homeRule and creature.book.type.name() eq 'OFFICAL'}"
					th:src="@{/resources/official.png}" height="20" width="20"
					title="офицальное"></td>
			</tr>
		</table>
		<div th:insert="fragments/pages :: pages(${creatures}, creatures)"></div>
	</div>
</body>

<script th:src="@{/webjars/jquery/3.3.1/jquery.min.js}"></script>
<script th:src="@{/webjars/popper.js/umd/popper.min.js}"></script>
<script th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
<script th:src="@{/resources/js/bootstrap-multiselect.js}"></script>
<script th:src="@{/resources/js/settings.js}"></script>

<script type="text/javascript">
	var changed = false;
	$(document).ready(function() {
		$('#sourceBook').multiselect({
			buttonWidth : '300px',
			includeSelectAllOption : true,
			nSelectedText : ' - выбрано',
			allSelectedText : "Все источники",
			selectAllText : 'Все источники',
			nonSelectedText : 'Выберите источник',
			onSelectAll : function() {
				changed = true;
			},
			onChange : function(option, checked, select) {
				changed = true;
			},
			onDropdownHide : function(event) {
				if (changed)
					filterSource(this);
				changed = false;
			}
		});
		$('#habitatType').multiselect({
			buttonWidth : '300px',
			includeSelectAllOption : true,
			nSelectedText : ' - выбрано',
			allSelectedText : "Все места",
			selectAllText : 'Все места',
			nonSelectedText : 'Выберите место обитания',
			onSelectAll : function() {
				changed = true;
			},
			onChange : function(option, checked, select) {
				changed = true;
			},
			onDropdownHide : function(event) {
				if (changed)
					filterHabitat(this);
				changed = false;
			}
		});
	});
</script>
<script>
	function sortTable(n) {
		var baseUrl = '[[@{/creatures?}]]';
		var sort = getParameterByName('sort');
		var page = getParameterByName('page');
		var parameters = "";
		if (n == 0) {
			if (sort == 'exp,desc') {
				parameters = "sort=exp,asc";
			} else {
				parameters = "sort=exp,desc";
			}
		}
		if (n == 1) {
			if (sort == 'name,desc') {
				parameters = "sort=name,asc";
			} else {
				parameters = "sort=name,desc";
			}
		}
		if (n == 2) {
			if (sort == 'type,desc') {
				parameters = "sort=type,asc";
			} else {
				parameters = "sort=type,desc";
			}
		}
		location.href = baseUrl + parameters;
	}

	function getParameterByName(name, url) {
		if (!url)
			url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex
				.exec(url);
		if (!results)
			return null;
		if (!results[2])
			return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

	function rowClicked(value) {
		var baseUrl = '[[@{/creatures/creature/}]]';
		location.href = baseUrl + value;
	}

	function filter() {
		var baseUrl = '[[@{/creatures?}]]';
		var sort = getParameterByName('sort');
		var type = $("#creatureType").val();
		var sort = getParameterByName('sort');
		var crMin = $("#crMin").val();
		var crMax = $("#crMax").val();
		var size = $("#creatureSize").val();
		var parameters = "&type=" + type + "&crMin=" + crMin + "&crMax="
				+ crMax + "&cSize=" + size;
		if (sort != null) {
			parameters += "&sort=" + sort;
		}
		window.location = baseUrl + parameters;
	}

	function filterHabitat(select) {
		var baseUrl = '[[@{/creatures?}]]';
		var habitatType = $("#habitatType").val();
		var parameters = "habitatType=" + habitatType;
		var sort = getParameterByName('sort');
		if (sort != null) {
			parameters += "&sort=" + sort;
		}
		window.location = baseUrl + parameters;
	}

	function filterSource(select) {
		var baseUrl = '[[@{/creatures?}]]';
		var source = $("#sourceBook").val();
		var parameters = "source=" + source;
		var sort = getParameterByName('sort');
		if (sort != null) {
			parameters += "&sort=" + sort;
		}
		window.location = baseUrl + parameters;
	}

	function filter(select, param) {
		var baseUrl = '[[@{/creatures?}]]';
		var value = select;
		var parameters = param + "=" + value;
		var sort = getParameterByName('sort');
		if (sort != null) {
			parameters += "&sort=" + sort;
		}
		window.location = baseUrl + parameters;
	}
</script>
</html>