<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="layouts/default">
<head>
<head>
<style>
.table>tbody .hiddenRow {
	padding: 0 8px;
}
</style>
<title>DnD 5E Черты персонажа</title>
<meta charset="utf-8">

<link rel="icon" th:href="@{/resources/icon.png}">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet"
	th:href="@{/webjars/bootstrap/4.3.1/css/bootstrap.min.css}" />
<link rel="stylesheet"
	th:href="@{/resources/css/bootstrap-multiselect.css}" />
<link rel="stylesheet" th:href="@{/resources/css/main.css}" />
<style>
.table>tbody .hiddenRow {
	padding: 0 8px;
}
</style>
</head>
<body>
	<div th:insert="fragments/header :: header(~{ :: .backgrounds})"></div>
	<div class="container" style="margin-top: 25px">
		<div th:replace="fragments/header :: saf"></div>
		<div id=filter class="collapse" th:classappend="${filtered} ? show">
			<div class="card">
				<div class="card-body">
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<label class="input-group-text" for="artifactType">Увеличение
								характеристик</label>
						</div>
						<select id="abilityType" class="custom-select" multiple="multiple">
							<option th:each="ability : ${abilities}" th:value="${ability}"
								th:text="${ability.cyrilicName}"
								th:selected="${selectedAbilities.contains(ability)}"></option>
						</select>
					</div>
					<div class="input-group mb-3">
						<div class="input-group-prepend">
							<label class="input-group-text" for="artifactType">Получение
								навыков</label>
						</div>
						<select id="skillType" class="custom-select" multiple="multiple">
							<option th:each="skill : ${skills}" th:value="${skill}"
								th:text="${skill.cyrilicName}"
								th:selected="${selectedSkills.contains(skill)}"></option>
						</select>
					</div>
					<div class="input-group mb-4">
						<div class="input-group-prepend">
							<label class="input-group-text" for="source">Источник</label>
						</div>
						<select id="sourceBook" class="custom-select" multiple="multiple">
							<option th:each="book : ${books}" th:value="${book.source}"
								th:text="${book.name}"
								th:selected="${selectedBooks.contains(book.source)}" />
						</select>
					</div>
					<div class="input-group mb-3">
						<a th:if="${filtered}" th:href="@{/hero/traits?clear}"
							role="button" class="btn btn-danger"><img
							th:src="@{/resources/open-iconic/svg/x.svg}"></img> &nbsp;
							Сбросить фильтры</a>
					</div>
				</div>
			</div>
		</div>
		<table class="table table-hover">
			<thead>
				<tr>
					<th scope="col">Черты</th>
					<th style="width: 1%"></th>
				</tr>
			</thead>
			<th:block th:each="trait : ${traits}">
				<tr data-toggle="collapse" th:attr="data-target='#d'+ ${trait.id}">
					<td th:text="${trait.name}">
					<td><img th:if="${trait.book.type.name() eq 'OFFICAL'}"
						th:src="@{/resources/official.png}" height="20" width="20"
						title="офицальное"></td>
				</tr>
				<tr>
					<td colspan="6" class="hiddenRow">
						<div th:id="'d' + ${trait.id}" class="collapse">
							<div class="card">
								<ul th:if="${trait.requirement}"
									class="list-group list-group-flush">
									<li class="list-group-item"><strong>Требования:</strong> <th:block
											th:text="${trait.requirement}" /></li>
								</ul>
								<div class="card-body" th:utext="${trait.description}"></div>
								<footer class="blockquote-footer">
									<small class="text-muted" th:if="${trait.book}"
										th:text="'Источник: ' + ${trait.book.name}"></small>
								</footer>
							</div>
						</div>
					</td>
				</tr>
				<th:block>
		</table>
		<div th:insert="fragments/pages :: pages(${traits}, traits)"></div>
	</div>
	<script th:src="@{/webjars/jquery/3.3.1/jquery.min.js}"></script>
	<script th:src="@{/webjars/popper.js/umd/popper.min.js}"></script>
	<script th:src="@{/webjars/bootstrap/4.3.1/js/bootstrap.min.js}"></script>
	<script th:src="@{/resources/js/bootstrap-multiselect.js}"></script>
	<script th:src="@{/resources/js/settings.js}"></script>
	
	<script type="text/javascript">
		var changed = false;
		$(document).ready(function() {
			$('#abilityType').multiselect({
				buttonWidth : '250px',
				enableFiltering : true,
				includeSelectAllOption : true,
				selectAllJustVisible : false,
				selectAllText : 'Все',
				nSelectedText : ' - выбрано',
				allSelectedText : "Все",
				nonSelectedText : 'не выбрано',
				onSelectAll : function() {
					changed = true;
				},
				onChange : function(option, checked, select) {
					changed = true;
				},
				onDropdownHide : function(event) {
					if (changed)
						filterAbility(this);
					changed = false;
				}
			});
			$('#skillType').multiselect({
				buttonWidth : '250px',
				enableFiltering : true,
				includeSelectAllOption : true,
				selectAllJustVisible : false,
				selectAllText : 'Все',
				nSelectedText : ' - выбрано',
				allSelectedText : "Все",
				nonSelectedText : 'не выбрано',
				onSelectAll : function() {
					changed = true;
				},
				onChange : function(option, checked, select) {
					changed = true;
				},
				onDropdownHide : function(event) {
					if (changed)
						filterSkill(this);
					changed = false;
				}
			});
			$('#sourceBook').multiselect({
				buttonWidth : '300px',
				includeSelectAllOption : true,
				nSelectedText : ' - выбрано',
				allSelectedText : "Все источники",
				selectAllText : 'Все источники',
				nonSelectedText : 'Выберите источник',
				onSelectAll : function() {
					changed = true;
				},
				onChange : function(option, checked, select) {
					changed = true;
				},
				onDropdownHide : function(event) {
					if (changed)
						filterSource(this);
					changed = false;
				}
			});
		});
	</script>
	<script type="text/javascript">
		var baseUrl = '[[@{/hero/traits?}]]';
		function filterAbility(select) {
			var abilityType = $("#abilityType").val();
			var parameters = "abilityType=" + abilityType;
			var sort = getParameterByName('sort');
			if (sort != null) {
				parameters += "&sort=" + sort;
			}
			window.location = baseUrl + parameters;
		}
		function filterSkill(select) {
			var skillType = $("#skillType").val();
			var parameters = "skillType=" + skillType;
			var sort = getParameterByName('sort');
			if (sort != null) {
				parameters += "&sort=" + sort;
			}
			window.location = baseUrl + parameters;
		}
		function filterSource(select) {
			var source = $("#sourceBook").val();
			var parameters = "source=" + source;
			var sort = getParameterByName('sort');
			if (sort != null) {
				parameters += "&sort=" + sort;
			}
			window.location = baseUrl + parameters;
		}
		function getParameterByName(name, url) {
			if (!url)
				url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex
					.exec(url);
			if (!results)
				return null;
			if (!results[2])
				return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
	</script>
</body>
</html>